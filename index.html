<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Palm Panic - Quest 3</title>

<style>
    body {
        margin: 0;
        padding: 0;
        background: black;
        font-family: Arial, sans-serif;
        overflow: hidden;
        color: white;
    }

    #ui-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        background: rgba(0,0,0,0.8);
        z-index: 10;
    }

    #panel {
        padding: 2rem;
        border-radius: 16px;
        background: rgba(0,0,0,0.85);
        border: 2px solid #444;
        max-width: 420px;
    }

    h1 {
        color: #ff3e3e;
        margin-bottom: 1rem;
    }

    button {
        margin-top: 1rem;
        padding: 1rem 2rem;
        font-size: 1.2rem;
        background: #ff3e3e;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
    }

    #score-board {
        position: absolute;
        top: 20px;
        width: 100%;
        text-align: center;
        font-size: 2rem;
        display: none;
        pointer-events: none;
    }

    #message-box {
        position: absolute;
        bottom: 10%;
        width: 100%;
        text-align: center;
        font-size: 1.5rem;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
    }
</style>
</head>

<body>

<div id="ui-overlay">
    <div id="panel">
        <h1>Palm Panic</h1>
        <p>
            Catch falling objects using the correct hand.<br><br>
            <span style="color:#4488ff;">BLUE = LEFT HAND</span><br>
            <span style="color:#ff4444;">RED = RIGHT HAND</span>
        </p>
        <button id="start-button">START GAME</button>
    </div>
</div>

<div id="score-board">SCORE: 0</div>
<div id="message-box"></div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { XRHandModelFactory } from 'three/addons/webxr/XRHandModelFactory.js';

let scene, camera, renderer;
let hand1, hand2;
let fallingObjects = [];
let score = 0;
let gameActive = false;
let spawnTimer = 0;
let spawnInterval = 2000;

const uiOverlay = document.getElementById("ui-overlay");
const scoreBoard = document.getElementById("score-board");
const messageBox = document.getElementById("message-box");
const startButton = document.getElementById("start-button");

init();

function init() {
    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.xr.enabled = true;
    renderer.xr.setReferenceSpaceType('local-floor');

    document.body.appendChild(renderer.domElement);

    const light = new THREE.HemisphereLight(0xffffff, 0x8888ff, 2);
    scene.add(light);

    const handFactory = new XRHandModelFactory();

    hand1 = renderer.xr.getHand(0);
    hand2 = renderer.xr.getHand(1);

    hand1.add(handFactory.createHandModel(hand1, "mesh"));
    hand2.add(handFactory.createHandModel(hand2, "mesh"));

    scene.add(hand1);
    scene.add(hand2);

    startButton.onclick = startXR;
    window.addEventListener("resize", onResize);
}

async function startXR() {
    if (!navigator.xr) {
        alert("WebXR not supported.");
        return;
    }

    try {
        const session = await navigator.xr.requestSession("immersive-vr", {
            requiredFeatures: ["local-floor"],
            optionalFeatures: ["hand-tracking", "dom-overlay"],
            domOverlay: { root: document.body }
        });

        renderer.xr.setSession(session);
        startGame();

    } catch (err) {
        console.error(err);
        alert("Failed to start XR");
    }
}

function startGame() {
    uiOverlay.style.display = "none";
    score = 0;
    scoreBoard.innerText = "SCORE: 0";
    scoreBoard.style.display = "block";
    gameActive = true;
    fallingObjects.length = 0;
    renderer.setAnimationLoop(render);
}

function spawnObject() {
    const left = Math.random() > 0.5;
    const color = left ? 0x4488ff : 0xff4444;

    const geo = new THREE.IcosahedronGeometry(0.06, 1);
    const mat = new THREE.MeshStandardMaterial({
        color,
        emissive: color,
        emissiveIntensity: 0.5
    });

    const mesh = new THREE.Mesh(geo, mat);
    mesh.position.set(
        (Math.random() - 0.5) * 0.6,
        1.8,
        -0.5
    );

    scene.add(mesh);

    fallingObjects.push({
        mesh,
        target: left ? "left" : "right",
        velocity: 0.008 + score * 0.0005
    });
}

function render(time) {
    if (!gameActive) return;

    if (time - spawnTimer > spawnInterval) {
        spawnObject();
        spawnTimer = time;
    }

    for (let i = fallingObjects.length - 1; i >= 0; i--) {
        const obj = fallingObjects[i];
        obj.mesh.position.y -= obj.velocity;

        const h1 = hand1.joints?.palm;
        const h2 = hand2.joints?.palm;

        const hit = checkHit(obj, h1, "left") || checkHit(obj, h2, "right");

        if (hit === "fail") return endGame("WRONG HAND");
        if (hit === "catch") continue;

        if (obj.mesh.position.y < 0.1) {
            endGame("MISSED!");
            return;
        }
    }

    renderer.render(scene, camera);
}

function checkHit(obj, joint, side) {
    if (!joint) return null;

    const pos = new THREE.Vector3().setFromMatrixPosition(joint.matrixWorld);
    const d = obj.mesh.position.distanceTo(pos);

    if (d < 0.12) {
        scene.remove(obj.mesh);
        fallingObjects.splice(fallingObjects.indexOf(obj), 1);

        if (side !== obj.target) return "fail";

        score++;
        scoreBoard.innerText = `SCORE: ${score}`;
        return "catch";
    }
    return null;
}

function endGame(msg) {
    gameActive = false;
    messageBox.innerText = msg;
    messageBox.style.opacity = 1;

    setTimeout(() => {
        uiOverlay.style.display = "flex";
        messageBox.style.opacity = 0;
    }, 1500);
}

function onResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}
</script>

</body>
</html>
